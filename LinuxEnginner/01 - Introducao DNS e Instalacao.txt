DNS - Domain Name System 

NS : name server

Temos DNS Corporativos e Publicos. 

    Ex. 8.8.8.8 --> Publicos 

Quando trabalhamos com controladores de dominio, temos que necessariamente ter um DNS. 
Logo, no mundo empresarial e quase que indispensavel um DNS Corporativo.

porta 53 (UDP) : Conexao Utilizada para conexao com o servidor DNS. 

Etapas para resolucao de nomes :

1 Verificao : Cache de respostas de enderecamento.

2 Verificao, Dominios auterentativos : Quais dominios o servidor DNS e responsavel. 

3 verificacao : Busca recursivas, pelos root-servers (Por NS)


**Implementacao do Servico de DNS S.O Debian utlizando CHROOT.**

Intranet : DNS Master 
DataCenter : DNS Slave 

CHROOT {
    Tem como objetivo de isolar o servico do DNS. Tudo relacionado ao DNS fica dentro de um
    so lugar. Isso a nivel de diretorio e tambem a nivel de security. Evitando exploits. 
}


ps. processo em ambas as maquinas, master e slave. 

1 PASSO - INSTALACAO DO PACOTE DE IMPLEMENTACAO DO SERVICO, INSTALAR EM AMBAS AS MAQUINAS.{
    apt update
    apt install bind9 bind9utils dnsutils -y

    -bind9 - Implementacao do servico
    -bind9utils dnsutils - Ferramentas
    -Bind tambem pode ser chamado de bind.service ou named.service. 
    -Os arquivos de config do bind9 ficam em /etc/bind. 
    -Arquivos de zona, ficam em /var/cache/bind/

    Esses sao os diretorios, padroes apos a instalacao do bind. Porem como vamos utilizar o conceito CHROOT.
    }

2 PASSO - ESCOLHER UM DIRETORIO PARA A IMPLEMENTACAO DO CHROOT.{

    mkdir -pv /var/bind9/chroot/{etc,dev,var/cache/bind,var/run/named}

    Principal diretorio do DNS.

    /var/bind9/chroot/etc : config files
    /var/bind9/chroot/dev : devices  
    /var/bind9/chroot/var/cache/bind : zone files 
    /var/bind9/chroot/var/run/named
}

3 PASSO - APONTANDO ESTRUTURA PARA O NOVO DIRETORIO. {

    vim /etc/default/named

    Vamos mudar os parametros de inicializacao em 'OPTIONS' para a linha abaixo.

    OPTIONS="-u bind -t /var/bind9/chroot"
        -t : target 

    Apos reiniciar o servico, ele vai atualizar o apontamento. 

}

4 PASSO - ATUALIZAR O SERVICO DO APPARMOR{

apparmor : Servico mandandatorios, ele tem como objetivo trazer uma protecao a mais. 
Podemos ver o status dele com 'aa-status'. Para atualizarmos. Vamos no arquivo : 

    vim /etc/apparmor.d/usr.sbin.named

    Vamos ate a linha :24 e adicionar a baixo das config de leitura e escrita.\

        /var/bind9/chroot/etc/bind/** r,
        /var/bind9/chroot/var/** rw,
        /var/bind9/chroot/dev/** rw,

    Apos isso, vamos reiniciar o servico com:
        systemctl restart apparmor 
}

5 PASSO - MOVER OS ARQUIVOS DE CONFIGURACAO.{

    Vamos movimentar as config:
        mv /etc/bind /var/bind9/chroot/etc/

    Depois disso vamos criar um link de acesso. Para facilitar :
        ln -s /var/bind9/chroot/etc/bind/ /etc/bind

    Vamos copiar o arquivo do time zone para termos a time zone ok:
        cp /etc/localtime /var/bind9/chroot/etc/
        timedatectl : mostra o arquivo localtime. 

}

6 PASSO - CRIAR DISPOSIVOS ESPECIAIS NO /DEV 

    Vamos entrar no diretorio de dispositivos. 
        cd /var/bind9/chroot/dev/

        Os dispositivos especiais sao:
            /dev/null
            /dev/random
            /dev/zero 

        Indentificadores dispositivos -> Kernel 
            1 maior/major 
            3 menor/minor 

    Vamos criar os dispositivos com o mknod.

        mknod null c 1 3        
        mknod random c 1 8
        chmod 660 *

        **|comando|dispositivos|tipo|major|minor
        ***mudando permissao para melhor security, deixando somente para usuario e grupo para ler e escrever.

7 PASSO - MUDANDO O PERMISSIONAMENTO PARA O USUARIO BIND. 

        chown bind:bind /var/bind9/chroot/etc/bind/rndc.key 
        chown bind:bind /var/bind9/chroot/var/ -R
        chmod 775 /var/bind9/chroot/var/ -R

8 PASSO - ALTERANDO PID DO SERVICO DO DNS. 

    Vamos acessar o diretorio do named na linha 28
        vim /etc/init.d/named
        :28

    Nessa linha vamos alterar o local do PID com a linha abaixo:
        PIDFILE=/var/bind9/chroot/var/run/named/named.pid

Agora a estrutura do CHROOT esta PRONTO!!! 
Porem o servico ainda nao vai subir.

9 PASSO - CLONAGEM REP HTTPS://GITHUB.COM/ROGERRAMOSSILVA/LINUXFORCE PARA FALICITAR CONFIG. 

    cd /root 
    apt install git vim man -y 
    git clone https://github.com/rogerramossilva/linuxforce 
    chattr -i /etc/resolv.conf   *Tirar protecao do resolv.conf

    Na Intranet  :
        cp /root/linuxforce/intranet/bind_chroot/etc/bind/named.conf* /etc/bind/            *copia de arquivos de configuracoes para /etc/
        cp /root/linuxforce/intranet/bind_chroot/bind/* /var/bind9/chroot/var/cache/bind/   *copia de arquivos de zona
        cp /root/linuxforce/intranet/bind_chroot/etc/resolv.conf /etc/                      *copia do resolv.conf para resolucao
        attr +i resolv.conf

    Na dataCenter:

    cp /root/linuxforce/datacenter/bind_chroot/etc/bind/* /etc/bind/
    cp /root/linuxforce/datacenter/bind_chroot/etc/resolv.conf /etc/
    chattr +i /etc/resolv.conf
    
10 PASSO - TRANSFERENCIA DA TSIG KEY. 

    O principal arquivo utilizado pelo servico DNS e o named.conf
    Nele faz uma chamada nos outros arquivos .conf do named. 
    
    cat /etc/bind/named.conf

        include "/etc/bind/named.conf.options"          *opcoes do servidor / configuracoes
        include "/etc/bind/named.conf.local";           *entrada de zonas DNS
        include "/etc/bind/named.conf.default-zones"    *zonas default e root-servers.
        include "/etc/bind/bind.keys";                  *chaves [Keys]


        include "/etc/bind/tsig.key";                   *chaves [troca de info segura, master/slave]   
            tsig -> protocolo usado dentro do DNS, para a troca de info ser feita com security
            contem chave da relacao de confianca entre a troca de info entre os 2 servers. (master,slave).
            Precisamos enviar a chave para o slave. Evitando roubo de zona. 
            ps. A mudanca de zona sempre precisa ser realizada na Master, e esta quando alterada precisa ser enviada para Slave.           
        

    *SOMENTE NA MASTER [INTRANET] VAMOS EXECUTAR OS COMANDOS ABAIXO:
        cd /etc/bind
        tsig-keygen TRANSFER > tsig.key 
        vim tsing.key
    
    Vamos add abaixo das linhas da chave a seguinte config:
        server 192.168.1.20 {
	    keys {TRANSFER; };
        };

    Agora vamos usar o scp para enviar o arquivo de key para o server slave.
        scp -P 52020 tsig.key analista@192.168.1.20:/tmp/  
    
    Vamos fazer o move conectado na slave e alterar a relacao de confianca. Para dizer qual server pode usar a chave. 
        mv /tmp/tsig.key /etc/bind/
        server 192.168.1.10 {
	    keys {TRANSFER; };
        };

    11 PASSO - COPIA DOS ROOT.HINTS  

    vim named.conf.default-zones            
    
    Zona Ponto / Root-Servers. 
        zone "." {
	    type hint;              *tipo hind, zona mestre. Define o root-server. 
	    file "root.hints";      *arquivo ele tem a relacao dos root-servers 
         };

    Vamos copiar o arquivo para o diretorio do bind9.
        
        cp -a /usr/share/dns/root.hints /var/bind9/chroot/var/cache/bind/
        cat /usr/share/dns/root.hints

        A : address ipv4 
        AAAA: address ipv6

    Podemos ver a relacao com :
        dig +trace www.oul.com.br

    12 PASSO - REINICIAR O SERVICO

        systemctl restart named
        systemctl status named
        systemctl enable named

        Para verificar qualquer erro no status : 
            named-checkconf
    
    13 PASSO - ENTENDENDO AS OPCOES DO SERVIDOR DNS E ARQUIVOS DE ZONA NO MASTER SERVER.

        Dentro de /etc/bind temos o arquivo de opcoes/configuracoes do servidor.
            named.conf.options {

                    directory "/var/cache/bind";                                                *diretorio de armazenamento das zonas dns **[lembrando que temos o link do chroot], ***[/var/cache/bind = /var/bind9/chroot/var/cache/bind]
                    version "not available";                                                    *utilizado para ocutar a versao do DNS.               
                    dnssec-enable yes;                                                          *Domain Name System Security Extetion, protocolo pra trazer seguranca. *[Obsoleto, comentar para tirar] 
                    dnssec-validation auto;                                                     *Validacao
                    allow-query { 200.50.100.0/24; 192.168.1.0/24; 10.0.0.0/24; 127.0.0.1; };   *Quem pode fazer consultas no servidor
                    allow-recursion { 192.168.1.0/24; 10.0.0.0/24; 127.0.0.1; };                *Consultas recursivas. 
                    allow-transfer { key TRANSFER; };                                           *Permissao de transferencia de zona 
                    forwarders { 8.8.8.8; };                                                    *Encaminhadores caso o servidor DNS nao tenha a resposta. 
                    notify yes;                                                                 *Coligado com a tranferencia de zona. Notificacoes 
                    also-notify { 192.168.1.20; };		                                        *Quais servidores serao notificados 
                    listen-on-v6 { any; };                                                      *Habilita a opcao Ipv6 

            }

    
    14 PASSO - CRIANDO ACLS NO MASTER SERVER
        Vamos entrar dentro do arquivo named.conf.local 
            vim /etc/bind/named.conf.local

    Vamos ser responsavel por 1 dominio, asf.com.
    Ele sera utilizado de forma interna [maquinas da rede interna] e tambem externa [maquina fora da rede]. 
    
    Quando temos consultas no DNS, temos 2 cenarios : 
        *Solicitacoes Rede Interna [info da rede interna]
        *Solicitacoes Rede Externa [info da rede externa]

    Para deixar isso funcional e correto, vamos precisar criar ACLS [Access control list]. 

    *ENTENDENDO A CONFIG* :


        include "/etc/bind/rndc.key";         #include key file

        inet 127.0.0.1 port 953 allow { localhost; } keys { "rndc-key"; };};         *Criacao do controle, liberando a chave default. [rndc]

        acl "redeinterna" {                 *1 ACL, utilizado para a rede interna e VPN.
        192.168.1.0/24;
        10.0.0.0/24;
        127.0.0.1;
        };
        
        acl "redeexterna" {                 *2 ACL, utilizado para a rede externa.                                                                          |
        200.50.100.0/24;                                                                                                                                    |
        };                                                                                                                                                  |
                                                                                                                                                            |
        view "externa" {                    **  View Externa                                                                                                |
        match-clients { redeexterna; };         Clientes que estao na ACL rede externa podem usar a view.                                                   |
        zone "asf.com" {                        Nome da zona                                                                                                |
            type master;                        Definindo zona master                                                                                       |
            file "db.asf.externa";              arquivo que a entrada da zona aponta. Arquivo precisa ser criado em /var/bind9/chroot/var/cache/bind        |
        };                                  **                                                                                                              |
                                                                                                                                                            |---->Solicitacoes rede externas, entrega de ip externo. 
        zone 100.50.200.in-addr.arpa {      **DNS Reverso, 100.50.200.[REDE].in-addr.arpa[Special domain] = 10.100.50.200                                   |
                                                                                                                                                            |
            type master;                                                                                                                                    |
            file "rev.asf.externa";                                                                                                                         |
            };                                                                                                                                              |
        };                                                                                                                                                  |

        view "interna" {                               
        match-clients { redeinterna; };    Clientes que estao na ACL rede interna podem usar a view.                                                        |
        zone "asf.com" {                   Nome da zona                                                                                                     |
            type master;                   Definindo zona master                                                                                            |
            file "db.asf.interna";         WWW IN A 192.168.1.10 (exemplo)                                                                                  |
        };                                                                                                                                                  |----->Solicitacoes rede interna, entrega de ip interno. 
        zone 1.168.192.in-addr.arpa {                                                                                                                       |
            type master;                                                                                                                                    |                                               
            file "rev.asf.interna";                                                                                                                         |
        };                                                                                                                                                  |
        };                                                                                                                                                  |

        Resumindo, 4 arquivos de zona, 2 view externa e 2 view interna. 
        
        *ps. na maquina slave, precisamos definir na config qual maquina e a slave.

        **Podemos fazer uma sincronizacao de um servidor DNS windows e um Linux. Master e slave. \

    15 PASSO - REGRA DE NAT (Na maquina Gateway)

    *Vamos criar uma regra que vai falar : 
        Toda conexao de origem 200.50.100.100 (cliente externo ) com destino a maquina 
        gateway (200.50.100.10) com protocolo udp e porta de destino 53 muda o endereco final 
        para 192.168.1.10. 

        Exemplo regra usando iptables :

        #Habilita a resolucao de nomes do cliente Externo
            iptables -t nat -A PREROUTING -p udp -i enp0s9 -s $LNK -d $FWL1 --dport 53 -j DNAT --to-destination $INT:53

    *dns 
    protocolo : udp 
    porta: 53 



        