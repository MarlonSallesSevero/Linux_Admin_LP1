DNS - Domain Name System 

NS : name server

Temos DNS Corporativos e Publicos. 

    Ex. 8.8.8.8 --> Publicos 

Quando trabalhamos com controladores de dominio, temos que necessariamente ter um DNS. 
Logo, no mundo empresarial e quase que indispensavel um DNS Corporativo.

porta 53 (UDP) : Conexao Utilizada para conexao com o servidor DNS. 

Etapas para resolucao de nomes :

1 Verificao : Cache de respostas de enderecamento.

2 Verificao, Dominios auterentativos : Quais dominios o servidor DNS e responsavel. 

3 verificacao : Busca recursivas, pelos root-servers (Por NS)


**Implementacao do Servico de DNS S.O Debian utlizando CHROOT.**

Intranet : DNS Master 
DataCenter : DNS Slave 

CHROOT {
    Tem como objetivo de isolar o servico do DNS. Tudo relacionado ao DNS fica dentro de um
    so lugar. Isso a nivel de diretorio e tambem a nivel de security. Evitando exploits. 
}


ps. processo em ambas as maquinas, master e slave. 

1 PASSO - Instalacao do pacote de Implementacao do Servico, instalar em ambas as maquinas.{
    apt update
    apt install bind9 bind9utils dnsutils -y

    -bind9 - Implementacao do servico
    -bind9utils dnsutils - Ferramentas
    -Bind tambem pode ser chamado de bind.service ou named.service. 
    -Os arquivos de config do bind9 ficam em /etc/bind. 
    -Arquivos de zona, ficam em /var/cache/bind/

    Esses sao os diretorios, padroes apos a instalacao do bind. Porem como vamos utilizar o conceito CHROOT.
    }

2 PASSO - Escolher um diretorio para a implementacao do CHROOT.{

    mkdir -pv /var/bind9/chroot/{etc,dev,var/cache/bind,var/run/named}

    Principal diretorio do DNS.

    /var/bind9/chroot/etc : config files
    /var/bind9/chroot/dev : devices  
    /var/bind9/chroot/var/cache/bind : zone files 
    /var/bind9/chroot/var/run/named
}

3 PASSO - APONTANDO ESTRUTURA PARA O NOVO DIRETORIO. {

    vim /etc/default/named

    Vamos mudar os parametros de inicializacao em 'OPTIONS' para a linha abaixo.

    OPTIONS="-u bind -t /var/bind9/chroot"
        -t : target 

    Apos reiniciar o servico, ele vai atualizar o apontamento. 

}

4 PASSO - Atualizar o servico do apparmor{

apparmor : Servico mandandatorios, ele tem como objetivo trazer uma protecao a mais. 
Podemos ver o status dele com 'aa-status'. Para atualizarmos. Vamos no arquivo : 

    vim /etc/apparmor.d/usr.sbin.named

    Vamos ate a linha :24 e adicionar a baixo das config de leitura e escrita.\

        /var/bind9/chroot/etc/bind/** r,
        /var/bind9/chroot/var/** rw,
        /var/bind9/chroot/dev/** rw,

    Apos isso, vamos reiniciar o servico com:
        systemctl restart apparmor 
}

5 PASSO - Mover os arquivos de configuracao.{

    Vamos movimentar as config:
        mv /etc/bind /var/bind9/chroot/etc/

    Depois disso vamos criar um link de acesso. Para facilitar :
        ln -s /var/bind9/chroot/etc/bind/ /etc/bind

    Vamos copiar o arquivo do time zone para termos a time zone ok:
        cp /etc/localtime /var/bind9/chroot/etc/
        timedatectl : mostra o arquivo localtime. 

}

6 PASSO - Criar disposivos especiais no /dev 

    Vamos entrar no diretorio de dispositivos. 
        cd /var/bind9/chroot/dev/

        Os dispositivos especiais sao:
            /dev/null
            /dev/random
            /dev/zero 

        Indentificadores dispositivos -> Kernel 
            1 maior/major 
            3 menor/minor 

    Vamos criar os dispositivos com o mknod.

        mknod null c 1 3        
        mknod random c 1 8
        chmod 660 *

        **|comando|dispositivos|tipo|major|minor
        ***mudando permissao para melhor security, deixando somente para usuario e grupo para ler e escrever.

7 PASSO - Mudando o permissionamento para o usuario bind. 

        chown bind:bind /var/bind9/chroot/etc/bind/rndc.key 
        chown bind:bind /var/bind9/chroot/var/ -R
        chmod 775 /var/bind9/chroot/var/ -R

8 PASSO - Alterando PID do servico do DNS. 

    Vamos acessar o diretorio do named na linha 28
        vim /etc/init.d/named
        :28

    Nessa linha vamos alterar o local do PID com a linha abaixo:
        PIDFILE=/var/bind9/chroot/var/run/named/named.pid

Agora a estrutura do CHROOT esta PRONTO!!! 
Porem o servico ainda nao vai subir.

9 PASSO - Clonagem rep https://github.com/rogerramossilva/linuxforce para falicitar config. 

    cd /root 
    apt install git vim man -y 
    git clone https://github.com/rogerramossilva/linuxforce 
    chattr -i /etc/resolv.conf   *Tirar protecao do resolv.conf

    Na Intranet  :
        cp /root/linuxforce/intranet/bind_chroot/etc/bind/named.conf* /etc/bind/            *copia de arquivos de configuracoes para /etc/
        cp /root/linuxforce/intranet/bind_chroot/bind/* /var/bind9/chroot/var/cache/bind/   *copia de arquivos de zona
        cp /root/linuxforce/intranet/bind_chroot/etc/resolv.conf /etc/                      *copia do resolv.conf para resolucao
        attr +i resolv.conf

    Na dataCenter:

    cp /root/linuxforce/datacenter/bind_chroot/etc/bind/* /etc/bind/
    cp /root/linuxforce/datacenter/bind_chroot/etc/resolv.conf /etc/
    chattr +i /etc/resolv.conf
    
10 PASSO - Transferencia da TSIG Key. 

    O principal arquivo utilizado pelo servico DNS e o named.conf
    Nele faz uma chamada nos outros arquivos .conf do named. 
    
    cat /etc/bind/named.conf

        include "/etc/bind/named.conf.options"          *opcoes do servidor / configuracoes
        include "/etc/bind/named.conf.local";           *entrada de zonas DNS
        include "/etc/bind/named.conf.default-zones"    *zonas default e root-servers.
        include "/etc/bind/bind.keys";                  *chaves []


        include "/etc/bind/tsig.key";                   *chaves [troca de info segura, master/slave]   
            tsig -> protocolo usado dentro do DNS, para a troca de info ser feita com security
            contem chave da relacao de confianca entre a troca de info entre os 2 servers. (master,slave).
            Precisamos enviar a chave para o slave. Evitando roubo de zona. 
            ps. A mudanca de zona sempre precisa ser realizada na Master, e esta quando alterada precisa ser enviada para Slave.           
        

    *SOMENTE NA MASTER [INTRANET] VAMOS EXECUTAR OS COMANDOS ABAIXO:
        cd /etc/bind
        tsig-keygen TRANSFER > tsig.key 
        vim tsing.key
    
    Vamos add abaixo das linhas da chave a seguinte config:
        server 192.168.1.20 {
	    keys {TRANSFER; };
        };

    Agora vamos usar o scp para enviar o arquivo de key para o server slave.
        scp -P 52020 tsig.key analista@192.168.1.20:/tmp/  
    
    Vamos fazer o move conectado na slave e alterar a relacao de confianca. Para dizer qual server pode usar a chave. 
        mv /tmp/tsig.key /etc/bind/
        server 192.168.1.10 {
	    keys {TRANSFER; };
        };

    11 PASSO - Copia dos root.hints  

    vim named.conf.default-zones            
    
    Zona Ponto / Root-Servers. 
        zone "." {
	    type hint;              *tipo hind, zona mestre. Define o root-server. 
	    file "root.hints";      *arquivo ele tem a relacao dos root-servers 
         };

    Vamos copiar o arquivo para o diretorio do bind9.
        
        cp -a /usr/share/dns/root.hints /var/bind9/chroot/var/cache/bind/
        cat /usr/share/dns/root.hints

        A : address ipv4 
        AAAA: address ipv6

    Podemos ver a relacao com :
        dig +trace www.oul.com.br

    12 PASSO - Reiniciar o servico

        systemctl restart named
        systemctl status named
        systemctl enable named

    Para verificar qualquer erro no status : 
        named-checkconf

    
